<% title "Shifts" %>
<%= render :partial => 'view_preferences' %>

<div id="shift_links">
  <div id="user_options">
    <%= render :partial => 'admin_options' if current_user.is_admin_of?(@department) %>
    <%= render :partial => 'user_options' %>
  </div>
  <div id="lists_of_shifts">
    <%= (render :partial => 'shifts/list_of_shifts/upcoming_shifts_layout', :object => @upcoming_shifts) unless @upcoming_shifts.empty? %>
    <%= (render :partial => 'shifts/list_of_shifts/subs_you_requested_layout', :object => @subs_you_requested) unless @subs_you_requested.empty? %>
    <%= (render :partial => 'shifts/list_of_shifts/subs_you_can_take_layout', :collection => @subs_you_can_take) unless @subs_you_can_take.empty? %>
    <%= (render :partial => 'shifts/list_of_shifts/active_shift_layout', :object => @active_shifts) unless @active_shifts.empty? %>
  </div>
</div>

<div id="schedule">
  <%= render :partial => 'schedule'%>
</div>

<div id="AJAX_status"></div><%# for AJAX status updates %>

<script>
  initialize("body");
  
  function initialize(div){
    $(div+' li.click_to_add_new').click(function (e) {
      popup_new($(this), e, this);
      return false;
    });

    $(div+' div.click_to_add_new').click(function (e) {
      popup_generic_new($(this), e);
      return false;
    });

    $(div+' li.click_to_show').click(function (e) {
      popup_show($(this));
      return false;
    });

    // $('li.click_to_edit').click(function (e) {
    //   popup_edit($(this));
    //   return false;
    // });

    //don't stop links from firing
    $(div+' li.click_to_show a').click(function (e) {
      e.stopPropagation();
    });

    $(div+' li.click_to_edit a').click(function (e) {
      e.stopPropagation();
    });
  }
  
  function popup_new(parent_element, e, raw_element){
    $(".tooltip").remove();
    
    var elementID = parent_element.attr('id');
    var params = elementID.split("_", 2);
    var locationID = params[0];//.substring(8); //remove "location" from id
    
    //cursor position magic
    var relX = e.pageX - getXOffset(raw_element);
    var widthPercentage = relX / parent_element.width();
    
    parent_element.append("<div class='loading' style='left:"+relX+"px'>Loading...</div>");
    
    var date = params[1];
    $.ajax({data:"elementID="+elementID+"&location_id="+locationID+"&date="+date+"&xPercentage="+widthPercentage, dataType:'script', type:'get', url:'<%= new_shift_path %>', async: false});
    
    $("div.tooltip").css("left",relX+"px")
    $(".loading").remove();
  }
  
  function popup_generic_new(parent_element, e){
    $(".tooltip").remove();
    
    var elementID = parent_element.attr('id');
    var params = elementID.split("_", 2);
    var locationID = params[0];//.substring(8); //remove "location" from id
    
    //cursor position magic
    var relX = e.pageX - getXOffset(raw_element);
    var widthPercentage = relX / parent_element.width();
    
    parent_element.append("<div class='loading' style='left:"+relX+"px'>Loading...</div>");
    
    var date = params[1];
    $.ajax({data:"elementID="+elementID+"&location_id="+locationID+"&date="+date+"&xPercentage="+widthPercentage, dataType:'script', type:'get', url:'<%= new_shift_path %>', async: false});
    
    $("div.tooltip").css("left",relX+"px")
    $(".loading").remove();
  }
  function popup_show(parent_element){
    $(".tooltip").remove();
    parent_element.append("<div class='loading'>Loading...</div>");
    
    var id = parent_element.attr('id').substring(5); //remove "shift" from id
    $.ajax({dataType:'script', type:'get', url:'<%= shifts_path %>/'+id, async: false});
    
    $(".loading").remove();
  }
  // 
  // function popup_edit(parent_element){
  //   $(".tooltip").remove();
  //   parent_element.append("<div class='loading'>Loading...</div>");
  //   
  //   var id = parent_element.attr('id').substring(8); //remove "timeslot" from id
  //   <%#= remote_function :url => root_path, :test => 5 %>
  //   $.ajax({dataType:'script', type:'get', url:'<%= time_slots_path %>/'+id+'/edit', async: false});
  //   
  //   $(".loading").remove();
  // }
  
  function getXOffset(element){
    var x = 0
    while(element){
        x += element.offsetLeft;
        element = element.offsetParent;
    }
    return x;    
  }
  
  //hide tooltip upon hitting escape
  // $(document).keypress(
  //   function (e){
  //     if (e.which == 0)  //WRONG
  //     {
  //       $(".tooltip").remove();
  //     }
  //   }
  // );
</script>
