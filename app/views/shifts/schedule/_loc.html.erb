<%
  @grace_period = 5*60 #seconds

  #Shift.find(:all, :conditions => {:location_id => loc}, :order => :start) : Shift.find(:all, :conditions => {:location_id => loc, :scheduled => true}, :order => :start))
  shifts = Shift.find(:all, :conditions => {:location_id => loc}, :order => :start).select{|shift| shift.end and ((shift.start < @day_end) and (shift.end > @day_start))}
  populate_loc(loc, shifts)
  shiftsplit = shifts.group_by(&:scheduled)
  @scheduled_shifts = [shiftsplit[true]]
  @unscheduled_shifts = [shiftsplit[false]]
%>

<tbody>
  <% @scheduled_shifts.each_with_index do |row_shifts, i| %>
    <tr class="location_row">
      <% if i==0 %>
        <th class="location_label" scope="rowgroup" rowspan="<%= loc.max_staff + 1 %>">
          <%#= link_toggle_unless loc.bar_no_active?, @bar_id, loc.short_name %>
          <%= loc.short_name %>
        </th>
      <% end %>
      
      <% @row_time = @day_start %>
      <% unless row_shifts.nil? %><%# if there are any shifts on this row, print them %>
        <%= render :partial => 'shifts/schedule/row_shift', :collection => row_shifts.sort_by(&:start), :locals => {:index => i} %>
      <% end %>
      <%= print_cell("free_time", @row_time, @day_end, nil, ' ') -%><%# print rest of free time for the day %>            
    </tr>
  <% end %>
  
  <% if @display_unscheduled_shifts and !@unscheduled_shifts.flatten.compact.empty? %>
    </tbody>
    <tbody>
    <% @unscheduled_shifts.each_with_index do |row_shifts, i| %>
      <tr class="unscheduled_row">
        <% if i==0 %>
          <th class="unscheduled_label" scope="rowgroup" rowspan="<%= loc.max_staff + 1 %>">
            <%#= link_toggle_unless loc.bar_no_active?, @bar_id, loc.short_name %>
            (unscheduled)
          </th>
        <% end %>
      
        <% @row_time = @day_start %>
        <% unless row_shifts.nil? %><%# if there are any shifts on this row, print them %>
          <%= render :partial => 'shifts/schedule/row_shift', :collection => row_shifts.sort_by(&:start), :locals => {:index => i} %>
        <% end %>
        <%= print_cell("free_time", @row_time, @day_end, nil, ' ') -%><%# print rest of free time for the day %>            
      </tr>
    <% end %>
  <% end %>
  
  <% unless true %> <%#loc.bar_no_active? %>
    <tr class="location_bar" id="<%= @bar_id %>" <%= @user.preference.show_bars? ? '' : 'style="display:none"' %>>
      <%= render :partial => 'shift/schedule/loc_bar', :collection => loc.bar, :locals => {:id => loc.id} %>
    </tr>
    <% @bar_ids[@curr_day] << @bar_id %>
  <% end %>
</tbody>