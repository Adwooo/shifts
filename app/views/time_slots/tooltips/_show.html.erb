<%= javascript_include_tag 'jeditable' %>

  <div class="close_link">
    <a onclick="$(this).parent().parent().fadeOut(function (){ $(this).remove() }); return false;" href="#">[x]</a>
  </div>
  <h2>Edit Timeslot</h2>
  <p>
    <strong>Location:</strong>
    <span id="time_slot_location" class="jeditable"><%=h @time_slot.location.name %></span>
  </p>
  <p>
    <strong>Start:</strong>
    <span id="time_slot_start" class="jeditable"><%=h @time_slot.start.to_s(:short_name) %></span>
  </p>
  <p>
    <strong>End:</strong>
    <span id="time_slot_end" class="jeditable"><%=h @time_slot.end.to_s(:short_name) %></span>
  </p>

  <p>
    <%= link_to "Edit", edit_time_slot_path(@time_slot) %> | 
    <% unless @time_slot.repeating_event %>
      <%= link_to_remote "Destroy this time slot", {:url => {:controller => 'time_slots', :action => 'destroy', :id => @time_slot.id, :calendar => params[:calendar]}, :confirm => 'Are you sure?', :method => :delete} %>
    <% else %>
      <%= link_to_function "Destroy this time slot", "$('#repeating_event_delete_options').toggle()" %>
      <div id="repeating_event_delete_options" style="display:none">
        <p>This shift is part of a repeating event.<br>What do you wish to destroy?</p>
        <%= button_to_remote "Just this time slot", {:url => {:controller => 'time_slots', :action => 'destroy', :id => @time_slot.id, :calendar => params[:calendar]}, :confirm => 'Are you sure?', :method => :delete} %><br>
        <%= button_to_remote "This and all future time slots", {:url => {:controller => 'repeating_events', :action => 'destroy', :id => @time_slot.repeating_event.id, :calendar => params[:calendar], :delete_after_date => @shift.start}, :confirm => 'Are you sure?', :method => :delete} %>
        <%= button_to_remote "All events in this series", {:url => {:controller => 'repeating_events', :action => 'destroy', :id => @time_slot.repeating_event.id, :calendar => params[:calendar]}, :confirm => 'Are you sure?', :method => :delete} %>
      </div>
    <% end %>
  </p>
  
  <script type="text/javascript">
    // don't retrigger the action when clicking the tooltip :P
    $(".tooltip").click(function(e){
      e.stopPropagation();
    });
  
    $('#time_slot_location').editable(
      <%= time_slot_path(@time_slot).to_json %>,
      {
        name: 'time_slot[location_id]',
        type: 'select',
        data: {<%= Location.all.collect{|loc| "'#{loc.id}':'#{loc.name}'" }.flatten * ", " %>},
        method: 'PUT',
        submitdata: {
          authenticity_token: <%= form_authenticity_token.to_json %>,
          wants: 'location'
        },
        cancel: 'Cancel',
        submit: 'OK',
        indicator: '<img src="../images/loading.gif">',
        tooltip: 'Click to edit...',
        callback: function(value) {
          update_schedule_view(value);
        }
      }
    );
    
    $('#time_slot_start').editable( <%= time_slot_path(@time_slot).to_json %>, {
      name: 'time_slot[start]',
      method: 'PUT',
      submitdata: {
        authenticity_token: <%= form_authenticity_token.to_json %>,
        wants: 'start'
      },
      cancel: 'Cancel',
      submit: 'OK',
      indicator: '<img src="../images/loading.gif">',
      tooltip: 'Click to edit...',
      callback: function(value) {
        update_schedule_view(value);
      }
    });
    
    $('#time_slot_end').editable( <%= time_slot_path(@time_slot).to_json %>, {
      name: 'time_slot[end]',
      method: 'PUT',
      submitdata: {
        authenticity_token: <%= form_authenticity_token.to_json %>,
        wants: 'end'
      },
      cancel: 'Cancel',
      submit: 'OK',
      indicator: '<img src="../images/loading.gif">',
      tooltip: 'Click to edit...',
      callback: function(value) {
        update_schedule_view(value);
      }
    });
    
    function update_schedule_view(value){
      if(value.substring(0,4) == "fail"){
        error_message();
      }
      else{
        rerender_timeslot();
      }
    }
    
    function error_message(){
      alert("Sorry, but the updated timeslot could not be saved.");
    }
    
    function rerender_timeslot(){
      $("#timeslot<%= @time_slot.id %>").remove();  // = time slot before edit
      // add new time slot to view
      $.ajax({dataType:'script', type:'get', url:'<%= rerender_time_slot_path(@time_slot) %>'});
    }
  </script>